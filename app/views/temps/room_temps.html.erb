<div class="row gtr-uniform">
  <div class="col-2 col-4-mobilep ">
    <%= link_to 'Back', temps_path, class: "button icon solid fa-chevron-left"%>
  </div>
  <div class="col-10 col-8-mobilep">
    <h2>Le temperature della stanza</h2>
  </div>
  <div class="col-12 col-12-mobilep">
    <br>
  </div>

  <% if @temps.present? %>
    <div id="ls" class="col-12 col-12-mobile">Loading...</div>
    <div class="col-12 col-12-mobile"><br></div>
    <!--<div style="width:30em">-->
    <div class="chart-container oneLineGraph">
      <canvas id="tempChart"></canvas>
    </div>
    <div class="col-12 col-12-mobile"><hr></div>
    <div class="col-8 col-12-mobile">
      <h3>Scegli il numero di dati che vuoi vedere per le medie</h3>
    </div>
    <div class="col-4 col-12-mobile">
      <select id="datanumber" onchange="updatedata(this.value)">
        <option value="7">7
        <option value="15">15
        <option value="30">30
        <option value="60">60
        <option value="100">100
      </select>
    </div>
    <div class="col-12 col-12-mobile"><br></div>
    <div class="chart-container oneLineGraph">
      <canvas id="medtempChart"></canvas>
    </div>
    <script>
        function updateReal(){
            $.post('Connector', {livesearch: "gettemp"}, function(data) {
                $("#ls").html("<h2><b>TEMP:</b> "+data+"</h2>");
            });
            setTimeout( updateReal, 300000 );
            //300 -> 288 lectures per day - once every 5 minutes
        }
        function updateTemps(){
            $.post('Connector', {livesearch: "updateTemps", dati:tempChart.data.labels[tempChart.data.labels.length - 1]}, function(data) {
                if(data.length>5 && data.length<35){
                    //output from the post call
                    //21.5?01:10:18?55.9
                    //0-4  5-8     14-4
                    //for temp
                    tempChart.data.labels.push(data.substr(5,8));
                    tempChart.data.datasets[0].data.push(data.substr(0,4));

                    if(tempChart.data.labels.length >= 100) {
                        tempChart.data.labels.shift();
                        tempChart.data.datasets[0].data.shift();
                    }
                    tempChart.update();
                }
            });
            setTimeout( updateTemps, 840000 );
            // un update ogni 14 minuti
            //setTimeout( updateTemps, 500 );
        }
        function startUpdate(){
            updateReal();
            setTimeout( updateTemps, 5000 );
        }
        //window.addEventListener("load", startUpdate);

        let ctx = document.getElementById("tempChart").getContext("2d");

        let tempChart = new Chart(ctx, {
            type:'line',
            data: {
                labels: [<% @temps.each do |temp| %>'<%=temp.created_at.strftime("%T")%>', <% end %>],
                datasets: [{label: 'Temperatures \u00B0C',
                    data: [<% @temps.each do |temp| %><%=temp.temp%>, <% end %>],
                    fill:!1, borderColor:"#3cb371", lineTension:0.1}]
            },options:{responsive:!0,maintainAspectRatio:!1,aspectRatio:1,scales: {yAxes: [{ticks: { beginAtZero:!1}}]}}
        });

        /*var labelsin = [%for(Lettura outmedrd : meds){out.print("'" + outmedrd.getReadingDate().toString() + "'" + ",");}%>];
        var medtmpsin = [%for(Lettura outmedrd : meds){out.print(String.valueOf(outmedrd.getTemp()) + ",");}%>];
        var medhumsin = [%for(Lettura outmedrd : meds){out.print(String.valueOf(outmedrd.getHum()) + ",");}%>];
        var ctmedh = document.getElementById("medhumChart").getContext("2d");
        */

        let ctmedt = document.getElementById("medtempChart").getContext("2d");


        let medtempChart = new Chart(ctmedt, {
        type:'line',
        data:{
            labels:[<% @meds.each do |m| %>'<%=m.giorno.strftime("%d-%m-%y")%>', <% end %>],
            datasets:[{label:'Medium Temps \u00B0C',
                data:[<% @meds.each do |m| %><%=m.temp %>, <% end %>],
                fill:!1,borderColor:"#216bff",lineTension:0.1}]},
        options:{responsive:!0,maintainAspectRatio:!1,aspectRatio:1,scales:{yAxes:[{ticks:{beginAtZero:!1}}]}}
        });

        function updatedata(numberOfValues){
            $.post('Connector', {livesearch: "getmeds", number: numberOfValues}, function(data) {
                if(data.length>15){
                    var datesN = data.search("#");
                    var dates = data.slice(0, datesN);
                    data = data.slice(datesN+1, data.length);
                    var tempsN = data.search("#");
                    var temps = data.slice(0, tempsN);
                    data = data.slice(tempsN+1, data.length);
                    var hums = data;

                    var valueNumber = medhumChart.data.labels.length;
                    var i;
                    for(i=0; i<valueNumber; i++) {
                        medtempChart.data.labels.pop();
                        medtempChart.data.datasets[0].data.pop();
                    }

                    for(i=0; i<numberOfValues; i++) {
                        var tmpN = dates.search(",");
                        var tmpDates = dates.slice(0, tmpN);
                        medhumChart.data.labels.push(tmpDates);
                        //update only once because the var with labels is the same for the 2 meds graphs
                        //so update both will result in duplicate labels for the dates
                        dates = dates.slice(tmpN+1, dates.length);

                        tmpN = temps.search(",");
                        var tmpTemps = temps.slice(0, tmpN);
                        medtempChart.data.datasets[0].data.push(tmpTemps);

                        temps = temps.slice(tmpN+1, temps.length);

                        tmpN = hums.search(",");
                        var tmpHums = hums.slice(0, tmpN);
                        medhumChart.data.datasets[0].data.push(tmpHums);
                        hums = hums.slice(tmpN+1, hums.length);
                    }
                    medhumChart.update();
                    medtempChart.update();
                }
            });
        }
    </script>
  <%else %>
    <div class="col-12 col-12-mobilep">
      <h3>Non c'&egrave; alcuna temperatura disponibile, attendi che il sensore ne legga qualcuna, poi torna qua</h3>
    </div>
  <% end %>
</div>